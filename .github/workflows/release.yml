name: Build and Release
# ProxyPin MCP Server ä¼ åº·KK å¢žå¼ºç‰ˆ - è‡ªåŠ¨æž„å»ºå‘å¸ƒæµç¨‹

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        architecture: ${{ matrix.arch }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        pyinstaller --onefile --name proxypin-mcp-server-windows-${{ matrix.arch }} proxypin_mcp_server.py
        
    - name: Create release info
      run: |
        echo "ProxyPin MCP Server ä¼ åº·KK ä¼˜åŒ–å¢žå¼ºç‰ˆ" > dist/README.txt
        echo "ä½œè€…: ä¼ åº·KK (GitHub: 1837620622)" >> dist/README.txt
        echo "å¾®ä¿¡: 1837620622" >> dist/README.txt
        echo "é‚®ç®±: 2040168455@qq.com" >> dist/README.txt
        echo "å¹³å°: å’¸é±¼/Bç«™ ä¸‡èƒ½ç¨‹åºå‘˜" >> dist/README.txt
        echo "" >> dist/README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> dist/README.txt
        echo "1. ç¡®ä¿ProxyPinæœåŠ¡è¿è¡Œåœ¨17777ç«¯å£" >> dist/README.txt
        echo "2. è¿è¡Œ: proxypin-mcp-server-windows-${{ matrix.arch }}.exe" >> dist/README.txt
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: proxypin-mcp-server-windows-${{ matrix.arch }}
        path: |
          dist/proxypin-mcp-server-windows-${{ matrix.arch }}.exe
          dist/README.txt

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          export ARCHFLAGS="-arch arm64"
          pyinstaller --onefile --target-arch arm64 --name proxypin-mcp-server-macos-${{ matrix.arch }} proxypin_mcp_server.py
        else
          pyinstaller --onefile --target-arch x86_64 --name proxypin-mcp-server-macos-${{ matrix.arch }} proxypin_mcp_server.py
        fi
        
    - name: Create release info
      run: |
        cat > dist/README.txt << 'EOF'
        ProxyPin MCP Server ä¼ åº·KK ä¼˜åŒ–å¢žå¼ºç‰ˆ
        ä½œè€…: ä¼ åº·KK (GitHub: 1837620622)
        å¾®ä¿¡: 1837620622
        é‚®ç®±: 2040168455@qq.com
        å¹³å°: å’¸é±¼/Bç«™ ä¸‡èƒ½ç¨‹åºå‘˜
        
        ä½¿ç”¨æ–¹æ³•:
        1. ç¡®ä¿ProxyPinæœåŠ¡è¿è¡Œåœ¨17777ç«¯å£
        2. ç»™äºˆæ‰§è¡Œæƒé™: chmod +x proxypin-mcp-server-macos-${{ matrix.arch }}
        3. è¿è¡Œ: ./proxypin-mcp-server-macos-${{ matrix.arch }}
        
        æ³¨æ„äº‹é¡¹:
        - macOSå¯èƒ½ä¼šæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸
        - å¦‚é‡æƒé™é—®é¢˜ï¼Œè¯·ä½¿ç”¨: sudo spctl --master-disable
        EOF
        
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: proxypin-mcp-server-macos-${{ matrix.arch }}
        path: |
          dist/proxypin-mcp-server-macos-${{ matrix.arch }}
          dist/README.txt

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Create release archives
      run: |
        mkdir -p releases
        
        # Windows releases
        for arch in x64 x86; do
          cd "proxypin-mcp-server-windows-${arch}"
          zip -r "../releases/proxypin-mcp-server-windows-${arch}.zip" .
          cd ..
        done
        
        # macOS releases  
        for arch in x64 arm64; do
          cd "proxypin-mcp-server-macos-${arch}"
          tar -czf "../releases/proxypin-mcp-server-macos-${arch}.tar.gz" .
          cd ..
        done
        
    - name: Generate release notes
      run: |
        cat > release_notes.md << 'EOF'
        # ProxyPin MCP Server ä¼ åº·KK ä¼˜åŒ–å¢žå¼ºç‰ˆ
        
        ## ðŸš€ æ–°ç‰¹æ€§
        - é«˜æ€§èƒ½HTTPè¯·æ±‚æ•èŽ·ä¸Žåˆ†æž
        - æ™ºèƒ½è¯·æ±‚è¿‡æ»¤ä¸Žæœç´¢åŠŸèƒ½
        - å¤šè¯­è¨€ä»£ç ç”Ÿæˆæ”¯æŒ
        - HARæ–‡ä»¶å¯¼å…¥å¯¼å‡º
        - è¯·æ±‚å¯¹æ¯”åˆ†æž
        - APIç«¯ç‚¹æ™ºèƒ½æå–
        - å¢žå¼ºçš„é”™è¯¯å¤„ç†ä¸Žæ—¥å¿—è®°å½•
        - è¿žæŽ¥æ± ä¼˜åŒ–
        - çº¿ç¨‹å®‰å…¨æ“ä½œ
        
        ## ðŸ‘¨â€ðŸ’» å¼€å‘è€…ä¿¡æ¯
        - **ä½œè€…**: ä¼ åº·KK (GitHub)
        - **å¾®ä¿¡**: 1837620622
        - **é‚®ç®±**: 2040168455@qq.com
        - **å¹³å°**: å’¸é±¼/Bç«™ ä¸‡èƒ½ç¨‹åºå‘˜
        - **GitHub**: https://github.com/1837620622
        
        ## ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
        
        ### Windows ç‰ˆæœ¬
        - `proxypin-mcp-server-windows-x64.zip` - 64ä½ç³»ç»Ÿ
        - `proxypin-mcp-server-windows-x86.zip` - 32ä½ç³»ç»Ÿ
        
        ### macOS ç‰ˆæœ¬
        - `proxypin-mcp-server-macos-x64.tar.gz` - IntelèŠ¯ç‰‡
        - `proxypin-mcp-server-macos-arm64.tar.gz` - Apple Mç³»åˆ—èŠ¯ç‰‡
        
        ## ðŸ”§ ä½¿ç”¨æ–¹æ³•
        
        1. ç¡®ä¿ProxyPinæœåŠ¡è¿è¡Œåœ¨17777ç«¯å£
        2. ä¸‹è½½å¯¹åº”å¹³å°çš„ç‰ˆæœ¬
        3. è§£åŽ‹å¹¶è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
        
        ### Windows
        ```bash
        # è§£åŽ‹åŽç›´æŽ¥è¿è¡Œ
        proxypin-mcp-server-windows-x64.exe
        ```
        
        ### macOS
        ```bash
        # è§£åŽ‹
        tar -xzf proxypin-mcp-server-macos-arm64.tar.gz
        
        # ç»™äºˆæ‰§è¡Œæƒé™
        chmod +x proxypin-mcp-server-macos-arm64
        
        # è¿è¡Œ
        ./proxypin-mcp-server-macos-arm64
        ```
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - macOSå¯èƒ½ä¼šæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸
        - ç¡®ä¿ProxyPinä¸»ç¨‹åºå·²å¯åŠ¨å¹¶ç›‘å¬17777ç«¯å£
        - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ `proxypin_mcp.log`
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        
        å¦‚é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
        - GitHub Issues: https://github.com/1837620622/proxypin-mcp-server/issues
        - å¾®ä¿¡: 1837620622
        - é‚®ç®±: 2040168455@qq.com
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ProxyPin MCP Server ${{ github.ref_name }} - ä¼ åº·KK ä¼˜åŒ–ç‰ˆ
        body_path: release_notes.md
        files: |
          releases/*.zip
          releases/*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-python-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: Build Python package
      run: |
        python -m build
        
    - name: Upload Python package artifact
      uses: actions/upload-artifact@v3
      with:
        name: python-package
        path: |
          dist/*.whl
          dist/*.tar.gz
